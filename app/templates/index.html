{% extends 'base.html' %} <!-- Updated for Drag and Drop -->




{% block content %}
</div>
<div class="d-flex justify-content-end mb-2 align-items-center">
    <button id="syncEllipseBtn" class="btn btn-sm btn-outline-primary me-2" onclick="syncEllipse()">
        <i class="bi bi-arrow-repeat"></i> Sync Realisasi
    </button>
    <span id="ellipseStatus" class="badge bg-secondary">
        <i class="bi bi-database me-1"></i> Ellipse: Checking...
    </span>
</div>
<div class="row mb-4">
    <div class="col-md-6 mb-3 mb-md-0">
        <div class="card shadow-sm border-left-primary h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Total Pagu Anggaran</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">Rp {{ total_pagu_total|ribuan }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow-sm border-left-success h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Total Realisasi (Ellipse)</div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">Rp {{ total_all_ellipse|ribuan }}</div>
                        <div class="small mt-1 text-success fw-bold">
                            <i class="bi bi-graph-up-arrow"></i> {{ total_percent|round(2) }}% dari Pagu
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">System Logs (Live)</h6>
            </div>
            <div class="card-body bg-light">
                <div id="systemLog" style="height: 100px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;"
                    class="text-secondary">
                    <div>[Init] Dashboard loaded...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header py-3">
                <h5 class="mb-0 fw-bold text-primary">Visualisasi Anggaran vs Realisasi - Tahun {{ selected_year }}</h5>
            </div>
            <div class="card-body" style="position: relative; height: 300px;">
                <canvas id="budgetChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold text-primary">Daftar Anggaran Operasi (AO) {{ selected_year }}</h5>
        <div class="d-flex align-items-center">
            {% if current_user.is_authenticated %}
            <a href="{{ url_for('main.export_excel') }}" class="btn btn-outline-success me-2">
                <i class="bi bi-download"></i> Export Data
            </a>
            {% endif %}

            {% if current_user.is_authenticated and current_user.has_permission('upload_prk') %}
            <button class="btn btn-success me-3" data-bs-toggle="modal" data-bs-target="#uploadPrkModal">
                <i class="bi bi-file-earmark-spreadsheet"></i> Import Excel
            </button>
            {% endif %}

            <form action="/" method="GET" class="d-flex">
                <select name="kode" class="form-select me-2" onchange="this.form.submit()">
                    <option value="">Semua Kode</option>
                    {% for code in unique_codes %}
                    <option value="{{ code }}" {% if kode_filter==code %}selected{% endif %}>{{ code }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>
    <div class="card-body p-0">
        <form id="bulkDeleteForm" action="{{ url_for('admin.delete_bulk_budget_lines') }}" method="POST"
            onsubmit="return confirm('Yakin ingin menghapus item yang dipilih? Semua rincian di dalamnya akan hilang.');">
            <div class="p-2 d-none bg-light border-bottom" id="bulkActions">
                <button type="submit" class="btn btn-sm btn-danger ms-2">
                    <i class="bi bi-trash"></i> Hapus yang Dipilih (<span id="selectedCount">0</span>)
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0 align-middle table-sm" style="font-size: 0.9em;">
                    <thead>
                        <tr>
                            {% if current_user.is_authenticated and current_user.has_permission('delete_budget_line') %}
                            <th rowspan="2" class="text-center align-middle" style="width: 40px;">
                                <input type="checkbox" id="selectAll" class="form-check-input"
                                    onclick="toggleSelectAll(this)" title="Pilih semua untuk dihapus">
                                <div style="font-size: 0.6rem; margin-top: 2px;" class="text-danger">Hapus</div>
                            </th>
                            {% endif %}
                            {% if current_user.has_permission('reorder_budget_lines') %}
                            <th rowspan="2" class="text-center align-middle" style="width: 30px;">
                                <i class="bi bi-arrows-move"></i>
                            </th>
                            {% endif %}
                            <th rowspan="2" class="text-center align-middle">No.</th>
                            <th rowspan="2" class="text-center align-middle">Kode</th>
                            <th rowspan="2" class="align-middle">No PRK</th>
                            <th rowspan="2" class="align-middle">Deskripsi</th>
                            <th colspan="3" class="text-center">Pagu</th>
                            <th colspan="4" class="text-center">Realisasi</th>
                            <th rowspan="2" class="text-center align-middle">Aksi</th>

                        </tr>
                        <tr>
                            <th class="text-end">Material</th>
                            <th class="text-end">Jasa</th>
                            <th class="text-end">Total</th>
                            <th class="text-end">Usulan RAB</th>
                            <th class="text-end">Terkontrak</th>
                            <th class="text-end">Terbayar</th>
                            <th class="text-end">Ellipse</th>
                        </tr>
                    </thead>
                    <tbody id="budgetTableBody">
                        {% for item in items %}
                        <tr data-id="{{ item.id }}">
                            {% if current_user.is_authenticated and current_user.has_permission('delete_budget_line') %}
                            <td class="text-center">
                                <input type="checkbox" name="ids" value="{{ item.id }}"
                                    class="form-check-input item-checkbox" onclick="updateBulkState()">
                            </td>
                            {% endif %}
                            {% if current_user.has_permission('reorder_budget_lines') %}
                            <td class="text-center align-middle handle" style="cursor: grab;">
                                <i class="bi bi-grip-vertical text-muted"></i>
                            </td>
                            {% endif %}
                            <td class="text-center row-number">{{ loop.index }}</td>
                            <td class="text-center align-middle">
                                <a href="{{ url_for('main.detail', kode=item.kode) }}" class="text-decoration-none">
                                    <span class="badge bg-info text-dark shadow-sm"
                                        style="font-size: 1.1rem; padding: 0.5em 0.8em;">{{ item.kode }}</span>
                                </a>
                            </td>
                            <td class="text-nowrap fw-bold">{{ item.no_prk }}</td>
                            <td class="text-truncate" style="max-width: 250px;" title="{{ item.deskripsi }}">{{
                                item.deskripsi }}</td>

                            <!-- Pagu -->
                            <td class="text-end">Rp {{ item.pagu_material|ribuan }}</td>
                            <td class="text-end">Rp {{ item.pagu_jasa|ribuan }}</td>
                            <td class="text-end fw-bold">Rp {{ item.pagu_total|ribuan }}</td>

                            <!-- Realisasi -->
                            <td class="text-end text-muted">Rp {{ item.usulan_rab_rp|ribuan }}</td>
                            <td class="text-end text-muted">Rp {{ item.terkontrak_rp|ribuan }}</td>
                            <td class="text-end text-muted">Rp {{ item.terbayar_rp|ribuan }}</td>
                            <td class="text-end text-muted">
                                <div>Rp {{ item.ellipse_rp|ribuan }}</div>
                                {% if item.pagu_total > 0 %}
                                <div class="badge bg-success bg-opacity-10 text-success fw-bold mt-1 px-2 border border-success"
                                    style="font-size: 0.85em;">
                                    {{ ((item.ellipse_rp or 0) / item.pagu_total * 100)|round(1) }}%
                                </div>
                                {% else %}
                                <div class="badge bg-secondary bg-opacity-10 text-secondary mt-1 px-2"
                                    style="font-size: 0.85em;">0%</div>
                                {% endif %}
                            </td>

                            {% if item.rowspan > 0 %}
                            <td class="text-center align-middle" rowspan="{{ item.rowspan }}"
                                style="border-left: 1px solid #dee2e6;">
                                <a href="{{ url_for('main.detail', kode=item.kode) }}"
                                    class="btn btn-sm btn-primary shadow-sm" style="font-size: 0.8rem;">
                                    Detail
                                </a>
                            </td>
                            {% endif %}


                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="12" class="text-center py-4 text-muted">Belum ada data anggaran.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="fw-bold" style="border-top: 2px solid var(--border-color);">
                        <tr>
                            <td colspan="{% if current_user.has_permission('delete_budget_line') %}5{% else %}4{% endif %}"
                                class="text-end">Grand Total</td>
                            <td class="text-end">Rp {{ total_pagu_material|ribuan }}</td>
                            <td class="text-end">Rp {{ total_pagu_jasa|ribuan }}</td>
                            <td class="text-end">Rp {{ total_pagu_total|ribuan }}</td>
                            <td colspan="5"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </form>
    </div>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // User Role Config
    const isAuthorized = "{{ 'true' if current_user.has_permission('reorder_budget_lines') else 'false' }}" === "true";

    // Drag and Drop Logic
    document.addEventListener('DOMContentLoaded', function () {
        const el = document.getElementById('budgetTableBody');

        if (isAuthorized && el) {
            new Sortable(el, {
                handle: '.handle', // handle's class
                animation: 150,
                onEnd: function (evt) {
                    // Get all IDs in new order
                    const rows = el.querySelectorAll('tr[data-id]');
                    const order = Array.from(rows).map(row => row.getAttribute('data-id'));

                    // Update Row Numbers visually
                    rows.forEach((row, index) => {
                        const numCell = row.querySelector('.row-number');
                        if (numCell) numCell.innerText = index + 1;
                    });

                    // Send to server
                    fetch('{{ url_for("admin.reorder_budget_lines") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ order: order }),
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                console.log('Order saved');
                            } else {
                                alert('Gagal menyimpan urutan: ' + (data.message || 'Unknown error'));
                            }
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                            alert('Terjadi kesalahan saat menyimpan urutan.');
                        });
                }
            });
        }
    });

    // Parse data safely to avoid IDE errors
    const chartLabels = JSON.parse('{{ chart_labels | tojson | safe }}');
    const chartPagu = JSON.parse('{{ chart_pagu | tojson | safe }}');
    const chartEllipse = JSON.parse('{{ chart_ellipse | tojson | safe }}');
    const chartSisa = JSON.parse('{{ chart_sisa | tojson | safe }}');
    const chartPercent = JSON.parse('{{ chart_percent | tojson | safe }}');

    const ctx = document.getElementById('budgetChart').getContext('2d');

    // Horizontal Stacked Bar Chart
    const budgetChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartLabels,
            datasets: [
                {
                    label: 'Realisasi (Ellipse)',
                    data: chartEllipse,
                    backgroundColor: 'rgba(25, 135, 84, 0.7)', // Green
                    borderColor: 'rgba(25, 135, 84, 1)',
                    borderWidth: 1,
                    order: 1
                },
                {
                    label: 'Sisa Anggaran',
                    data: chartSisa,
                    backgroundColor: 'rgba(108, 117, 125, 0.3)', // Grey/Muted
                    borderColor: 'rgba(108, 117, 125, 0.5)',
                    borderWidth: 1,
                    order: 2
                }
            ]
        },
        options: {
            indexAxis: 'y', // Horizontal Orientation
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'y', // Interaction mode specific to horizontal index
                intersect: false,
            },
            scales: {
                x: { // Value Axis (Currency)
                    stacked: true,
                    beginAtZero: true,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: {
                        color: '#94A3B8',
                        callback: function (value) {
                            return 'Rp ' + (value / 1000).toLocaleString('id-ID');
                        }
                    }
                },
                y: { // Category Axis (Labels)
                    stacked: true,
                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                    ticks: { color: '#94A3B8' }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            let label = context.dataset.label || '';
                            if (label) { label += ': '; }
                            if (context.parsed.x !== null) {
                                return label + 'Rp ' + (context.parsed.x / 1000).toLocaleString('id-ID');
                            }
                            return label;
                        },
                        footer: function (tooltipItems) {
                            let total = 0;
                            let realisasi = 0;

                            tooltipItems.forEach(function (tooltipItem) {
                                total += tooltipItem.parsed.x;
                                if (tooltipItem.datasetIndex === 0) { // Index 0 is Realisasi
                                    realisasi = tooltipItem.parsed.x;
                                }
                            });

                            let percent = (total > 0) ? (realisasi / total) * 100 : 0;

                            return 'Total Pagu: Rp ' + (total / 1000).toLocaleString('id-ID') + '\n' +
                                'Realisasi: ' + percent.toFixed(2).replace('.', ',') + '%';
                        }
                    }
                },
                legend: {
                    labels: { color: '#94A3B8' }
                }
            }
        }
    });
</script>
<!-- Modal Upload -->
<div class="modal fade" id="uploadPrkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Data PRK (Excel)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('admin.upload_prk') }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="alert alert-info py-2 mb-3">
                        <small>Unduh template sebelum upload:</small> <br>
                        <a href="{{ url_for('admin.download_template') }}" class="fw-bold text-decoration-none"><i
                                class="bi bi-download"></i> Download Template (Excel)</a>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Tahun Anggaran</label>
                        <input type="number" name="tahun" class="form-control" value="{{ selected_year }}" required>
                        <small class="text-muted">Pastikan tahun sesuai dengan data di Excel.</small>
                    </div>

                    <p class="small text-muted mb-1">Format Excel Columns: Kode, No PRK, Deskripsi, Pagu Material, Pagu
                        Jasa</p>
                    <input type="file" name="file" class="form-control" required accept=".xlsx, .xls">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-success">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    function toggleSelectAll(source) {
        const checkboxes = document.querySelectorAll('.item-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = source.checked;
        });
        updateBulkState();
    }

    function updateBulkState() {
        const checkboxes = document.querySelectorAll('.item-checkbox:checked');
        const bulkActions = document.getElementById('bulkActions');
        const countSpan = document.getElementById('selectedCount');

        if (checkboxes.length > 0) {
            bulkActions.classList.remove('d-none');
            countSpan.innerText = checkboxes.length;
        } else {
            bulkActions.classList.add('d-none');
        }
    }
</script>

<script>
    // Check Ellipse Connection Status
    function logMessage(msg, type = 'info') {
        const logDiv = document.getElementById('systemLog');
        if (!logDiv) return;

        const time = new Date().toLocaleTimeString();
        const color = type === 'success' ? 'text-success' : (type === 'error' ? 'text-danger' : 'text-secondary');
        const entry = document.createElement('div');
        entry.className = color;
        entry.innerText = `[${time}] ${msg}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    logMessage('Checking connection to Ellipse Database (192.168.3.205)...');

    fetch('/admin/check-ellipse')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('ellipseStatus');
            if (badge) {
                if (data.status === 'connected') {
                    badge.className = 'badge bg-success';
                    badge.innerHTML = '<i class="bi bi-database-check me-1"></i> Ellipse: Connected';
                    badge.title = data.message;
                    logMessage('SUCCESS: ' + data.message, 'success');
                } else {
                    badge.className = 'badge bg-danger';
                    badge.innerHTML = '<i class="bi bi-database-x me-1"></i> Ellipse: Disconnected';
                    badge.title = data.message;
                    logMessage('FAILED: ' + data.message, 'error');
                }
            }
        })
        .catch(err => {
            console.error('Failed to check ellipse status', err);
            logMessage('ERROR: Network/API failure to check status.', 'error');
        });

    function syncEllipse() {
        const btn = document.getElementById('syncEllipseBtn');
        const originalText = btn.innerHTML;

        if (!confirm('Update data realisasi dari Ellipse untuk semua PRK tahun ini?')) return;

        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-arrow-repeat spin"></i> Syncing...';
        logMessage('Starting Ellipse Sync...', 'info');

        fetch('{{ url_for("admin.sync_realization") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    logMessage('SYNC COMPLETE: ' + data.message, 'success');
                    alert(data.message);
                    location.reload(); // Reload to show new values
                } else {
                    logMessage('SYNC FAILED: ' + data.message, 'error');
                    alert('Gagal Sync: ' + data.message);
                }
            })
            .catch(err => {
                console.error(err);
                logMessage('SYNC ERROR: Network failure', 'error');
                alert('Terjadi kesalahan koneksi.');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = originalText;
            });
    }
</script>
<style>
    @keyframes spin {
        100% {
            transform: rotate(360deg);
        }
    }

    .spin {
        display: inline-block;
        animation: spin 1s linear infinite;
    }
</style>
{% endblock %}